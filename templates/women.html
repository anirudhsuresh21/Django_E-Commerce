{% extends 'base.html' %} {% load static %} {% block title %}Home {% endblock title %} {% block content %}
<a href="index.html" class="logo"
  ><img
    height="150px"
    src="{% static '/assets/img/foreverfinds.png' %}"
    alt=""
    class="img-fluid"
    style="max-height: 150px; margin: 10px 0"
/></a>
{% endblock content %} {% block body %}

<!-- ======= Portfolio Section ======= -->
<section id="portfolio" class="portfolio">
  <div class="container">
    <div class="section-title">
      <h2>Welcome to our Shop</h2>
      <h4>Check our <span>Products</span></h4>
    </div>

    {% for product, range, nSlides in allProds %}
    <br />
    <h3
      class="my-3 text-center text-success bg-light border border-success rounded"
    >
      {{product.0.category}} Flash Sale
    </h3>

    <div class="container">
      <div class="row">
        {% for i in product %}
        <div class="col-md-3 mt-3">
          <div class="product-card">
            {% if i.sale_price %}
            <div class="sale-badge">
              <span>{{ i.discount_percentage }}% OFF</span>
            </div>
            {% endif %}

            <div class="product-image">
              <img
                src="/media/{{ i.main_image }}"
                alt="{{i.product_name}}"
                class="card-img-top"
              />
            </div>

            <div class="product-details">
              <div class="category-tag">{{ i.get_category_display }}</div>
              <h5 class="product-title" id="namepr{{i.product_id}}">
                {{i.product_name}}
              </h5>

              <div class="price-section">
                {% if i.sale_price %}
                <div class="price-wrap">
                  <span class="original-price">₹{{i.price}}</span>
                  <h6 class="product-price">
                    ₹<span id="pricepr{{i.product_id}}">{{i.sale_price}}</span>
                  </h6>
                </div>
                {% else %}
                <h6 class="product-price">
                  ₹<span id="pricepr{{i.product_id}}">{{i.price}}</span>
                </h6>
                {% endif %}
              </div>

              {% if i.occasion_type or i.custom_sizing_available %}
              <div class="product-meta">
                {% if i.occasion_type %}
                <span class="occasion">{{ i.occasion_type }}</span>
                {% endif %} {% if i.custom_sizing_available %}
                <span class="custom-size"
                  ><i class="fas fa-ruler"></i> Custom Size</span
                >
                {% endif %}
              </div>
              {% endif %}

              <div class="button-group" id="divpr{{i.product_id}}">
                {% if i.stock > 0 %}
                <span id="divpr{{i.id}}" class="divpr">
                  <button id="pr{{i.product_id}}" class="btn-cart cart">
                    <i class="fa-solid fa-cart-shopping"></i> Add To Cart
                  </button>
                </span>
                {% else %}
                <button class="btn-out-of-stock" disabled>Out of Stock</button>
                {% endif %}

                <button
                  class="btn-view"
                  onclick="showProductDetails({{ i.product_id }})"
                >
                  <i class="fa-solid fa-eye"></i> View
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        <br />
      </div>
    </div>
    {% endfor %}
  </div>
</section>
<!-- End Portfolio Section -->
<script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
  integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
  crossorigin="anonymous"
></script>
<script
  src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
  integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
  crossorigin="anonymous"
></script>

<script>
  // Replace the existing cart functions with these new ones
  function addToCart(productId, quantity = 1) {
    $.ajax({
      url: "/api/cart/add/",
      type: "POST",
      data: {
        product_id: productId,
        quantity: quantity,
        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
      },
      success: function (response) {
        updateCartDisplay(response);
        showNotification("Product added to cart");
      },
      error: function (xhr) {
        showNotification("Error adding to cart", "error");
      },
    });
  }

  function removeFromCart(productId) {
    $.ajax({
      url: "/api/cart/remove/",
      type: "POST",
      data: {
        product_id: productId,
        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
      },
      success: function (response) {
        updateCartDisplay(response);
        showNotification("Product removed from cart");
      },
      error: function (xhr) {
        showNotification("Error removing from cart", "error");
      },
    });
  }

  function updateQuantity(productId, quantity) {
    $.ajax({
      url: "/api/cart/update/",
      type: "POST",
      data: {
        product_id: productId,
        quantity: quantity,
        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
      },
      success: function (response) {
        updateCartDisplay(response);
      },
      error: function (xhr) {
        showNotification("Error updating cart", "error");
      },
    });
  }

  function updateCartDisplay(cartData) {
    // Update cart count
    $("#cart").text(cartData.total_items);

    // Update cart popover content
    let popoverContent = `<h5>Cart Items</h5><div class='mx-2 my-2'>`;
    cartData.items.forEach((item) => {
      popoverContent += `
            <div class="cart-item">
                <span>${item.product_name}</span>
                <span>x ${item.quantity}</span>
                <span>₹${item.total_price}</span>
            </div>`;
    });
    popoverContent += `
        <hr><b>Total: ₹${cartData.total_amount}</b></div>
        <a href='/checkout'><button class='btn btn-success mx-2'>Checkout</button></a>
        <button class='btn btn-danger' onclick='clearCart()'>Clear Cart</button>`;

    $("#popcart").attr("data-content", popoverContent);
    $("#popcart").popover("update");
  }

  function showNotification(message, type = "success") {
    // Add your notification logic here
    alert(message); // Replace with better notification system
  }

  // Update the click handlers
  $(".divpr").on("click", "button.cart", function () {
    let productId = this.id.replace("pr", "");
    addToCart(productId);
  });

  $(".divpr").on("click", "button.minus", function () {
    let productId = this.id.slice(7);
    updateQuantity(productId, -1);
  });

  $(".divpr").on("click", "button.plus", function () {
    let productId = this.id.slice(6);
    updateQuantity(productId, 1);
  });

  function clearCart() {
    $.ajax({
      url: "/api/cart/clear/",
      type: "POST",
      data: {
        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
      },
      success: function (response) {
        updateCartDisplay({ total_items: 0, items: [], total_amount: 0 });
        showNotification("Cart cleared");
      },
      error: function (xhr) {
        showNotification("Error clearing cart", "error");
      },
    });
  }

  function showProductDetails(productId) {
    $("#modalProductContent").html(
      '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>'
    );
    $("#productModal").modal("show");

    $.get(`/api/product/${productId}/`, function (data) {
      let content = `
        <div class="row">
            <div class="col-md-6">
                <div class="product-images">
                    <div class="main-image">
                        <img src="/media/${data.main_image}" alt="${
        data.product_name
      }" class="img-fluid" id="modalMainImage">
                    </div>
                    <div class="thumbnail-images">
                        ${
                          data.image_2
                            ? `<img src="/media/${data.image_2}" alt="Additional view" onclick="changeModalImage(this.src)">`
                            : ""
                        }
                        ${
                          data.image_3
                            ? `<img src="/media/${data.image_3}" alt="Additional view" onclick="changeModalImage(this.src)">`
                            : ""
                        }
                        ${
                          data.image_4
                            ? `<img src="/media/${data.image_4}" alt="Additional view" onclick="changeModalImage(this.src)">`
                            : ""
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="product-details-content">
                    <div class="category-badge">${data.category}</div>
                    <h1 class="product-title">${data.product_name}</h1>
                    
                    <span id="namepr${data.id}" style="display:none">${
        data.product_name
      }</span>
                    <span id="pricepr${data.id}" style="display:none">${
        data.sale_price || data.price
      }</span>

                    <div class="price-section">
                        ${
                          data.sale_price
                            ? `<div class="sale-price">
                                <span class="original-price">₹${data.price}</span>
                                <span class="current-price">₹${data.sale_price}</span>
                                <span class="discount-badge">${data.discount_percentage}% OFF</span>
                            </div>`
                            : `<h2 class="product-price">₹${data.price}</h2>`
                        }
                    </div>

                    <div class="product-meta">
                        <div class="meta-item">
                            <span class="label">Category:</span>
                            <span class="value">${data.category}</span>
                        </div>
                        <div class="meta-item">
                            <span class="label">Style:</span>
                            <span class="value">${data.style || "N/A"}</span>
                        </div>
                        <div class="meta-item">
                            <span class="label">Occasion:</span>
                            <span class="value">${
                              data.occasion_type || "N/A"
                            }</span>
                        </div>
                    </div>

                    <div class="product-description">
                        <h3>Description</h3>
                        <p>${data.description}</p>
                    </div>

                    ${
                      data.fabric
                        ? `<div class="fabric-info">
                            <h4>Fabric Details</h4>
                            <p>${data.fabric}</p>
                            ${
                              data.work_type
                                ? `<p class="work-type">Work: ${data.work_type}</p>`
                                : ""
                            }
                        </div>`
                        : ""
                    }

                    <div class="size-selection">
                        <h4>Select Size</h4>
                        <div class="size-options">
                            ${
                              Array.isArray(data.sizes_available) &&
                              data.sizes_available.length > 0
                                ? data.sizes_available
                                    .map(
                                      (size) =>
                                        `<label class="size-option">
                                        <input type="radio" name="size" value="${size}">
                                        <span>${size}</span>
                                    </label>`
                                    )
                                    .join("")
                                : "<p>No size options available</p>"
                            }
                        </div>
                        ${
                          data.custom_sizing_available
                            ? `<div class="custom-size-note">
                                <i class="fas fa-ruler"></i> Custom sizing available
                            </div>`
                            : ""
                        }
                    </div>

                    <div class="product-actions">
                        <div class="stock-info ${
                          data.stock > 0 ? "in-stock" : "out-of-stock"
                        }">
                            ${
                              data.stock > 0
                                ? `<i class="fas fa-check-circle"></i> In Stock`
                                : `<i class="fas fa-times-circle"></i> Out of Stock`
                            }
                        </div>

                        ${
                          data.stock > 0
                            ? `<span id="divpr${data.id}" class="divpr">
                                <button id="pr${data.id}" class="btn-cart cart">
                                    <i class="fa-solid fa-cart-shopping"></i> Add To Cart
                                </button>
                            </span>`
                            : ""
                        }
                    </div>

                    <div class="delivery-info">
                        <i class="fas fa-truck"></i>
                        <span>Estimated Delivery: ${
                          data.delivery_time || "3-5 business days"
                        }</span>
                        ${
                          data.alteration_available
                            ? `<div class="alteration-note">
                                <i class="fas fa-scissors"></i> Alteration service available
                            </div>`
                            : ""
                        }
                    </div>
                </div>
            </div>
        </div>`;

      $("#modalProductTitle").text(data.product_name);
      $("#modalProductContent").html(content);
    });
  }

  function changeModalImage(src) {
    $(".main-image").attr("src", src);
  }
</script>

<!-- Add CSRF token -->
{% csrf_token %}

<!-- Product Details Modal -->
<div
  class="modal fade"
  id="productModal"
  tabindex="-1"
  role="dialog"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalProductTitle"></h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalProductContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<style>
  .product-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
    background: white;
    height: 100%;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .product-image {
    position: relative;
    overflow: hidden;
    padding-top: 75%;
  }

  .product-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-details {
    padding: 1.25rem;
  }

  .product-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
  }

  .product-description {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 1rem;
  }

  .price-section {
    margin-bottom: 1rem;
  }

  .product-price {
    font-size: 1.2rem;
    color: #2c3e50;
    font-weight: 700;
  }

  .button-group {
    display: flex;
    gap: 0.5rem;
  }

  .btn-cart,
  .btn-view {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 5px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: background-color 0.3s;
  }

  .btn-cart {
    background-color: #e74c3c;
    color: white;
  }

  .btn-cart:hover {
    background-color: #c0392b;
  }

  .btn-view {
    background-color: #34495e;
    color: white;
    text-decoration: none;
  }

  .btn-view:hover {
    background-color: #2c3e50;
    color: white;
  }

  .section-title {
    margin-bottom: 2rem;
  }

  .section-title h4 span {
    color: #e74c3c;
  }

  .sale-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #e74c3c;
    color: white;
    padding: 0.5rem;
    border-radius: 25px;
    font-size: 0.8rem;
    z-index: 1;
  }

  .category-tag {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .price-wrap {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .original-price {
    text-decoration: line-through;
    color: #999;
    font-size: 0.9rem;
  }

  .product-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: #666;
    margin: 0.5rem 0;
  }

  .btn-out-of-stock {
    background: #95a5a6;
    color: white;
    cursor: not-allowed;
    opacity: 0.8;
  }

  .modal-dialog.modal-lg {
    max-width: 1100px;
  }

  .modal-content {
    padding: 20px;
  }

  #modalProductContent .product-images,
  #modalProductContent .product-details-content {
    margin: 0;
    padding: 15px;
  }

  #modalProductContent .thumbnail-images {
    margin-top: 15px;
  }

  #modalProductContent .product-actions {
    margin: 20px 0;
  }

  .thumbnail-images {
    display: flex;
    gap: 10px;
  }

  .thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    cursor: pointer;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .thumbnail:hover {
    border-color: #007bff;
  }

  .main-image {
    border-radius: 8px;
    width: 100%;
    height: auto;
  }
</style>
{% endblock body %}
