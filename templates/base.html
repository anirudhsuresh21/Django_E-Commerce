{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>{% block title %}{% endblock title %}</title>
    <meta content="cars sale websites" name="description" />
    <meta content="vehiclesales, car, bikessales" name="keywords" />

    <!-- Favicons -->
    <link href="{% static '/assets/img/logo12.png' %}" rel="icon" />
    <link
      href="{% static '/assets/img/apple-touch-icon.png' %}"
      rel="apple-touch-icon"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link
      href="{% static '/assets/vendor/bootstrap/css/bootstrap.min.css ' %}"
      rel="stylesheet"
    />
    <link
      href="{% static '/assets/vendor/bootstrap-icons/bootstrap-icons.css ' %}"
      rel="stylesheet"
    />
    <link
      href="{% static '/assets/vendor/boxicons/css/boxicons.min.css ' %}"
      rel="stylesheet"
    />
    <link
      href="{% static '/assets/vendor/glightbox/css/glightbox.min.css ' %}"
      rel="stylesheet"
    />
    <link
      href="{% static '/assets/vendor/remixicon/remixicon.css ' %}"
      rel="stylesheet"
    />
    <link
      href="{% static '/assets/vendor/swiper/swiper-bundle.min.css ' %}"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
      integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Template Main CSS File -->
    <link href="{% static '/assets/css/style.css' %}" rel="stylesheet" />
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header" class="fixed-top">
      <div class="container d-flex align-items-center justify-content-between">
        <!-- Uncomment below if you prefer to use an image logo -->
        <a href="index.html" class="logo"
          ><img
            height="150px"
            src="{% static '/assets/img/foreverfinds.png' %}"
            alt=""
            class="img-fluid"
            style="max-height: 100px; margin: 10px 0"
        /></a>

        <nav id="navbar" class="navbar">
          <ul>
            <li><a class="nav-link scrollto" href="/">Home</a></li>
            <li><a class="nav-link scrollto" href="/about">About</a></li>
            <li><a class="nav-link scrollto" href="/checkout/">Checkout</a></li>
            <li><a class="nav-link scrollto" href="/profile">My Profile</a></li>
            <li>
              <a class="nav-link" href="{% url 'mens_collection' %}"
                >Groom Collection</a
              >
            </li>
            <li>
              <a class="nav-link" href="{% url 'womens_collection' %}"
                >Bridal Collection</a
              >
            </li>
            <li>
              <div class="cart-wrapper">
                <button
                  type="button"
                  class="nav-link scrollto btn-cart-nav"
                  id="cartButton"
                  data-bs-toggle="popover"
                  data-bs-placement="bottom"
                  data-bs-html="true"
                  title="Shopping Cart"
                >
                  <i class="fa-solid fa-cart-shopping"></i> Cart (<span
                    id="cart"
                    >0</span
                  >)
                </button>
              </div>
            </li>

            {% if request.user.is_authenticated %}
            <li>
              <a class="nav-link scrollto" href="/auth/logout/"
                >Logout <i class="fa-solid fa-right-from-bracket"></i>
              </a>
            </li>
            {% else %}
            <li class="dropdown">
              <a href="#"
                ><span>SignIn <i class="fa-solid fa-user"></i></span>
                <i class="bi bi-chevron-down"></i
              ></a>

              <ul>
                <li>
                  <a href="/auth/signup/"
                    >Sign Up <i class="fa-solid fa-user"></i
                  ></a>
                </li>
                <li><a href="/auth/login/">Login</a></li>
              </ul>
            </li>
            {% endif %}

            <li>
              <a class="nav-link scrollto bg-success p-2 m-2" href="/contact"
                >Contact</a
              >
            </li>
          </ul>
          <i class="bi bi-list mobile-nav-toggle"></i>
        </nav>
        <!-- .navbar -->
      </div>
    </header>
    <!-- End Header -->

    <!-- ======= Hero Section ======= -->
    <section id="hero">
      <div class="hero-container">
        {% block content %}{% endblock content %}
      </div>
    </section>
    <!-- End Hero -->

    <main id="main">{% block body %}{% endblock body %}</main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer">
      <div class="footer-top">
        <div class="container">
          <div class="row">
            <div class="col-lg-3 col-md-6 footer-contact">
              <h3>WeShop</h3>
              <p>
                A108 Adam Street <br />
                New York, NY 535022<br />
                United States <br /><br />
                <strong>Phone:</strong> +1 5589 55488 55<br />
                <strong>Email:</strong> weshop_@outlook.com<br />
              </p>
            </div>

            <div class="col-lg-2 col-md-6 footer-links">
              <h4>Useful Links</h4>
              <ul>
                <li>
                  <i class="bx bx-chevron-right"></i> <a href="/">Home</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="/about">About us</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="/termsofservice/">Terms of service</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="/privacypolicy/">Privacy policy</a>
                </li>
              </ul>
            </div>

            <div class="col-lg-3 col-md-6 footer-links">
              <h4>Our Products</h4>
              <ul>
                <li>
                  <i class="bx bx-chevron-right"></i> <a href="#">Mobiles</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i> <a href="#">Earphones</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i> <a href="#">Cameras</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i> <a href="#">Watches</a>
                </li>
              </ul>
            </div>

            <div class="col-lg-4 col-md-6 footer-newsletter">
              <form action="" method="post">
                <input type="email" name="email" /><input
                  type="submit"
                  value="Subscribe"
                />
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="container d-md-flex py-4">
        <div class="me-md-auto text-center text-md-start">
          <div class="copyright">
            &copy; Copyright <strong><span>WeShop</span></strong
            >. All Rights Reserved
          </div>
          <div class="credits">
            Designed by
            <a
              href="https://www.ruiacollege.edu/Department/Deptindex.aspx?page=a&ItemID=caeao&nDeptID=ei"
              >CS Department Ruia College @2023-2024 Batch</a
            >
          </div>
        </div>
        <div class="social-links text-center text-md-right pt-3 pt-md-0">
          <a
            href="https://youtube.com/shorts/1xwiywnaYDA?si=ROBY_ivjqPS0EFJn"
            class="twitter"
            ><i class="bx bxl-youtube"></i
          ></a>
          <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
          <a
            href="https://www.instagram.com/reel/CtvSADMsxQg/?utm_source=ig_web_copy_link&igshid=MzRlODBiNWFlZA=="
            class="instagram"
            ><i class="bx bxl-instagram"></i
          ></a>
          <a
            href="https://github.com/anirudhsuresh21/WeShop_Django"
            class="google-plus"
            ><i class="fa-brands fa-github"></i
          ></a>
          <a
            href="https://www.linkedin.com/in/achari-anirudh-suresh-5a286124b"
            class="linkedin"
            ><i class="bx bxl-linkedin"></i
          ></a>
        </div>
      </div>
    </footer>
    <!-- End Footer -->

    <a
      href="#"
      class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <!-- Vendor JS Files -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static '/assets/vendor/glightbox/js/glightbox.min.js' %}"></script>
    <script src="{% static '/assets/vendor/isotope-layout/isotope.pkgd.min.js' %}"></script>
    <script src="{% static '/assets/vendor/swiper/swiper-bundle.min.js' %}"></script>

    <!-- Template Main JS File -->
    <script src="{% static '/assets/js/main.js' %}"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let popoverInstance = null;
        let cartLoaded = false; // âœ… Prevents infinite API calls

        function getCSRFToken() {
          return document.cookie
            .split("; ")
            .find((row) => row.startsWith("csrftoken="))
            ?.split("=")[1];
        }

        function initializePopover() {
          const cartButton = document.getElementById("cartButton");
          if (cartButton) {
            popoverInstance = new bootstrap.Popover(cartButton, {
              html: true,
              content:
                '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>',
            });

            cartButton.addEventListener("shown.bs.popover", function () {
              if (!cartLoaded) {
                // âœ… Prevents redundant API calls
                fetchCartData();
                cartLoaded = true;
              }
            });

            cartButton.addEventListener("hidden.bs.popover", function () {
              cartLoaded = false; // âœ… Reset flag when popover is closed
            });
          }
        }

        function fetchCartData() {
          $.ajax({
            url: "/api/cart/info/",
            type: "GET",
            success: function (response) {
              renderCartContent(response);
            },
            error: function () {
              renderCartContent({ total_items: 0, items: [], total_amount: 0 });
            },
          });
        }

        function renderCartContent(cartData) {
          const cartButton = document.getElementById("cartButton");
          if (!cartButton) return;

          document.getElementById("cart").textContent =
            cartData.total_items || 0;

          let content = `<div class="cart-popover">`;

          if (!cartData.items || cartData.items.length === 0) {
            content += `<div class="text-center p-3">Your cart is empty</div>`;
          } else {
            content += `
                    <div class="cart-items">
                        ${cartData.items
                          .map(
                            (item) => `
                            <div class="cart-item mb-2">
                                <div class="item-header d-flex justify-content-between">
                                    <div class="item-name">${
                                      item.product_name
                                    }</div>
                                    <button class="btn btn-sm btn-link text-danger remove-item" 
                                            onclick="removeFromCart(${
                                              item.product_id
                                            })">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="price-info">
                                        <span class="price">â‚¹${
                                          item.sale_price || item.price
                                        }</span>
                                        <span class="quantity">Ã— ${
                                          item.quantity
                                        }</span>
                                    </div>
                                    <div class="quantity-controls">
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="updateQuantity(${
                                                  item.product_id
                                                }, ${
                              item.quantity - 1
                            })">-</button>
                                        <span class="mx-2">${
                                          item.quantity
                                        }</span>
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="updateQuantity(${
                                                  item.product_id
                                                }, ${
                              item.quantity + 1
                            })">+</button>
                                    </div>
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    <div class="cart-footer mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Total:</strong>
                            <strong>â‚¹${cartData.total_amount}</strong>
                        </div>
                        <div class="cart-actions">
                            <a href="/checkout/" class="btn btn-success btn-sm w-100 mb-2">Checkout</a>
                            <button onclick="clearCart()" class="btn btn-outline-danger btn-sm w-100">Clear Cart</button>
                        </div>
                    </div>`;
          }
          content += `</div>`;

          if (popoverInstance) {
            popoverInstance.setContent({ ".popover-body": content });
          }
        }

        window.updateQuantity = function (productId, newQuantity) {
          $.ajax({
            url: "/api/cart/update/",
            type: "POST",
            headers: { "X-CSRFToken": getCSRFToken() },
            data: { product_id: productId, quantity: newQuantity },
            success: function (response) {
              cartLoaded = false; // âœ… Reset flag to fetch updated cart
              renderCartContent(response);
            },
          });
        };

        window.clearCart = function () {
          $.ajax({
            url: "/api/cart/clear/",
            type: "POST",
            headers: { "X-CSRFToken": getCSRFToken() },
            success: function () {
              cartLoaded = false; // âœ… Reset flag to fetch updated cart
              renderCartContent({ total_items: 0, items: [], total_amount: 0 });
            },
          });
        };

        window.removeFromCart = function (productId) {
          $.ajax({
            url: "/api/cart/remove/",
            type: "POST",
            headers: { "X-CSRFToken": getCSRFToken() },
            data: { product_id: productId },
            success: function (response) {
              cartLoaded = false;
              renderCartContent(response);
            },
          });
        };

        document.addEventListener("click", function (e) {
          const cartButton = document.getElementById("cartButton");
          if (!cartButton) return;

          const popover = bootstrap.Popover.getInstance(cartButton);
          if (popover && !e.target.closest("#cartButton, .popover")) {
            popover.hide();
          }
        });

        initializePopover();
        fetchCartData();
      });
    </script>

    <style>
      .cart-popover {
        min-width: 250px;
        max-width: 350px;
        padding: 15px;
      }

      .cart-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s;
      }

      .cart-item:hover {
        background-color: #f8f9fa;
      }

      .item-header {
        align-items: start;
      }

      .item-name {
        font-weight: 500;
        font-size: 0.9rem;
        flex: 1;
        padding-right: 10px;
      }

      .remove-item {
        padding: 0;
        color: #dc3545;
        opacity: 0.7;
        transition: opacity 0.3s;
      }

      .remove-item:hover {
        opacity: 1;
        color: #dc3545;
      }

      .price-info {
        font-size: 0.85rem;
        color: #666;
      }

      .quantity-controls {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 4px;
        padding: 2px;
      }

      .quantity-controls button {
        padding: 2px 6px;
        font-size: 0.8rem;
      }

      .quantity-controls .mx-2 {
        min-width: 20px;
        text-align: center;
      }

      .cart-footer {
        border-top: 2px solid #eee;
        padding-top: 10px;
        margin-top: 10px;
      }

      .cart-actions {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .btn-cart-nav {
        padding: 8px 15px;
        border: none;
        background: none;
        color: inherit;
      }

      .btn-cart-nav:hover {
        color: #e74c3c;
      }
    </style>
    {% csrf_token %}
  </body>
</html>
