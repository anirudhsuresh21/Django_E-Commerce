{% extends 'base.html' %}
{% block title %}Home{% endblock title %} 
{% block content %}
<h1> Welcome to Dhamaka Sale</h1>
{% endblock content %}

{% block body %}
{% load static %}

    <!-- ======= Portfolio Section ======= -->
    <section id="portfolio" class="portfolio section-bg">
        <div class="container" data-aos="fade-up">
  
          <div class="section-title">
            <h2>Our Store</h2>
            <h4>Check our <span>Products</span></h4>
            <p>Discover amazing deals on premium products</p>
          </div>
  
          {% for product, range, nSlides in allProds %}
          <br>
    <h3 class="my-3 text-center text-success bg-light border border-success rounded">
      ðŸ”¥ {{product.0.category}} Flash Sale
    </h3>

    <div class="container">
      <div class="row">

        {% for i in product %}
        <div class="col-md-3 mt-3 product-card" data-aos="fade-up" data-aos-duration="600">
          <div class="product-wrapper">
            <div class="product-badge-container">
              <span class="product-badge">NEW</span>
            </div>
            <div class="product-image-container">
              <img src="/media/{{i.image}}" class="card-img-top" alt="{{i.product_name}}" loading="lazy" />
              <div class="product-overlay">
                <button class="btn btn-light btn-sm quick-view" 
                        data-id="{{i.id}}"
                        data-name="{{i.product_name}}"
                        data-desc="{{i.desc}}"
                        data-price="{{i.price}}"
                        data-image="/media/{{i.image}}"
                        data-category="{{product.0.category}}">
                  <i class="fa-solid fa-expand"></i> Quick View
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="product-category-tag">{{product.0.category}}</div>
              <h5 class="card-title mt-2" id="namepr{{i.id}}">{{i.product_name}}</h5>
              <p class="card-text">{{i.desc|slice:"0:53"}}...</p>
              <div class="product-price-section">
                <div class="price-wrapper">
                  <span class="price-label">Price</span>
                  <h6 class="product-price">
                    â‚¹<span id="pricepr{{i.id}}">{{i.price}}</span>
                  </h6>
                </div>
                <div class="product-rating">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star-half-alt"></i>
                  <span class="rating-count">(4.5)</span>
                </div>
              </div>
              <div class="product-actions">
                <span id="divpr{{i.id}}" class="divpr flex-grow-1">
                  <button id="pr{{i.id}}" class="btn btn-add-cart cart w-100">
                    <i class="fa-solid fa-cart-plus"></i> Add to Cart
                  </button>
                </span>
                <button class="btn btn-view-details view-details" 
                        data-id="{{i.id}}"
                        data-name="{{i.product_name}}"
                        data-desc="{{i.desc}}"
                        data-price="{{i.price}}"
                        data-image="/media/{{i.image}}"
                        data-category="{{product.0.category}}">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        <br>
        <br>
        

        {% endfor %}
        <br>
      </div>
    </div>
    {% endfor %}
  
        </div>
      </section>
      <!-- End Portfolio Section -->

      <!-- Product Details Modal -->
      <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content" style="border-radius: 20px; border: none; overflow: hidden;">
            <div class="modal-header" style="background: var(--gradient-primary); color: white; border: none;">
              <h5 class="modal-title" id="productModalLabel" style="font-weight: 700; font-size: 24px;">Product Details</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
              <div class="row g-0">
                <div class="col-md-6" style="background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 40px;">
                  <img id="modalProductImage" src="" alt="Product" style="max-width: 100%; max-height: 400px; border-radius: 16px; box-shadow: var(--shadow-lg);">
                </div>
                <div class="col-md-6" style="padding: 40px;">
                  <div class="badge mb-3" id="modalProductCategory" style="background: var(--gradient-secondary); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 12px;"></div>
                  <h3 id="modalProductName" style="font-weight: 800; color: var(--text-dark); margin-bottom: 16px; font-size: 28px;"></h3>
                  <p id="modalProductDesc" style="color: var(--text-light); line-height: 1.8; font-size: 15px; margin-bottom: 24px;"></p>
                  <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <p style="margin: 0; color: var(--text-light); font-size: 14px; font-weight: 600;">Price</p>
                    <h2 id="modalProductPrice" style="color: var(--primary-color); font-weight: 800; margin: 8px 0 0 0; font-size: 36px;"></h2>
                  </div>
                  <div class="d-grid gap-2">
                    <button id="modalAddToCart" class="btn btn-danger btn-lg" style="padding: 14px; font-weight: 600; border-radius: 12px;">
                      <i class="fa-solid fa-cart-shopping"></i> Add to Cart
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal" style="padding: 12px; font-weight: 600; border-radius: 12px; border-width: 2px;">
                      Continue Shopping
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
 
<script>
  
  //find pout the card from local storage

  if (localStorage.getItem('cart') == null) {
      var cart = {};
  } else {
      cart = JSON.parse(localStorage.getItem('cart'));
      updateCart(cart);

  }

  // Product Modal functionality
  document.addEventListener('DOMContentLoaded', function() {
    const viewButtons = document.querySelectorAll('.view-details, .quick-view');
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    
    viewButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const productId = this.getAttribute('data-id');
        const productName = this.getAttribute('data-name');
        const productDesc = this.getAttribute('data-desc');
        const productPrice = this.getAttribute('data-price');
        const productImage = this.getAttribute('data-image');
        const productCategory = this.getAttribute('data-category');
        
        document.getElementById('modalProductName').textContent = productName;
        document.getElementById('modalProductDesc').textContent = productDesc;
        document.getElementById('modalProductPrice').textContent = 'â‚¹' + productPrice;
        document.getElementById('modalProductImage').src = productImage;
        document.getElementById('modalProductCategory').textContent = productCategory + ' Category';
        
        const modalAddButton = document.getElementById('modalAddToCart');
        modalAddButton.setAttribute('data-id', productId);
        
        modal.show();
      });
    });

    // Add to cart from modal
    document.getElementById('modalAddToCart').addEventListener('click', function() {
      const productId = 'pr' + this.getAttribute('data-id');
      const button = document.getElementById(productId);
      if (button) {
        button.click();
        modal.hide();
      }
    });
  });

  // add or increment code

  // $('.cart').click(function() {
  $('.divpr').on('click', 'button.cart', function() {
      var idstr = this.id.toString();
      console.log(idstr)

      if (cart[idstr] != undefined) {
          qty = cart[idstr][0] + 1;

      } else {
          qty = 1;
          name = document.getElementById('name' + idstr).innerHTML;
          price = document.getElementById('price' + idstr).innerHTML;
          cart[idstr] = [qty, name, price];
          
      }
      updateCart(cart);

      localStorage.setItem('cart', JSON.stringify(cart));
      document.getElementById('cart').innerHTML = Object.keys(cart).length;
      console.log( Object.keys(cart).length)
      document.getElementById("popcart").click();
  });
  // add pop over to cart

  $('#popcart').popover();

  updatePopover(cart);
  function updatePopover(cart) {

      
      console.log('we are  inside update popover');
      
      var popStr = "";
      var popStr = popStr + "<h5> Cart for your items in my shopping cart </h5> <div class='mx-2 my-2'>";
      var i = 1;
      for (var item in cart) {
          popStr = popStr + "<b>" + i + "</b>. ";
          popStr = popStr + document.getElementById('name' + item).innerHTML.slice(0, 19) + "..." + "<b>" +cart[item][0] + "</b>"+ "Qty"  + '<br>';
          i = i + 1;
      }

      popStr = popStr + "</div> <a href='/checkout'><button class='btn btn-success' id='clearCart'>Checkout</button></a>  <button class='btn btn-dark' onclick='clearCart()' id='clearCart'>ClearCart</button>"
      document.getElementById('popcart').setAttribute('data-content', popStr);
      $('#popcart').popover('show');
      document.getElementById("popcart").click();
  }

  function clearCart() {
      cart = JSON.parse(localStorage.getItem('cart'));
      for (var item in cart) {
          document.getElementById('div' + item).innerHTML = '<button id="' + item + '" class="btn btn-add-cart cart w-100"><i class="fa-solid fa-cart-plus"></i> Add to Cart</button>'
      }
      localStorage.clear();
      cart = {};
      updateCart(cart);
      
     let clear= document.getElementById("popcart").click();
     document.getElementById("popcart").click(); 
  }

  function updateCart(cart) {
      var sum = 0;
      for (var item in cart) {
          sum = sum + cart[item][0];
          document.getElementById('div' + item).innerHTML = "<button id='minus" + item + "'class='btn btn-success minus'>-</button> <span id='val" + item + "''>" + cart[item][0] + "</span> <button id='plus" + item + "' class='btn btn-success plus'> + </button>";
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      document.getElementById('cart').innerHTML = sum;
      console.log(cart);
      updatePopover(cart);
      document.getElementById("popcart").click();
  }

  //if plus or minus button is clicked change the cart as well as the display value
  $('.divpr').on("click", "button.minus", function() {

      a = this.id.slice(7, );
      cart['pr' + a][0] = cart['pr' + a][0] - 1;
      cart['pr' + a][0] = Math.max(0, cart['pr' + a][0]);
      document.getElementById('valpr' + a).innerHTML = cart['pr' + a][0];
      updateCart(cart);      
  })

  $('.divpr').on("click", "button.plus", function() {

      a = this.id.slice(6, );
      cart['pr' + a][0] = cart['pr' + a][0] + 1;

      document.getElementById('valpr' + a).innerHTML = cart['pr' + a][0];
      updateCart(cart);
  })
</script>
{% endblock body %}